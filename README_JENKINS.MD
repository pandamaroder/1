Общая информация
----

#### Требования к именованию каталогов, переменных окружения и названиям сборок:

* Все имена должны содержать только латинские символы, без пробелов (возможно использование символов `-` и `_`).
    > В дальнейшем, у сборок в Jenkins можно указать отображаемое имя в настройках.

* Именование глобальных переменных заглавными латинскими буквами.
    > Использование глобальных переменных в конфигурации Jenkins: символ `$` перед именем
    > * **$WORKSPACE** – для получения значения переменной `WORKSPACE`
    
    > Использование глобальных переменных в консольных командах Windows: символ `%` перед и после имени
    > * **%WORKSPACE%** – для получения значения переменной `WORKSPACE`
    
    > Глобальные переменные будут использоваться для запуска тестов в шагах сборки в `Выполнить команду Windows`.

#### Часто используемые команды Windows для сборочных операций:
* CALL (выполнить командный bat файл: `CALL %VENV_ACT%` - активировать виртуальное окружение, путь к `activate.bat` содержится в переменной `VENV_ACT`)
* CD (смена директории: `CD %TESTS%` - перейти в директорию из переменной `TESTS`)
* SET (установить значение глобальной переменной: `SET ALR_DIR=%WORKSPACE%\allure-results`)
* REM (комментарий, данная строка не будет выполняться)

#### Используемые директории и настройки по умолчанию
* Используемые директории:
    > * `D:\jenkins` - директория в которую установлен Jenkins
    > * `D:\smd_framework\venv` - директория c виртуальным окружением `Venv`
    > * `D:\smd_framework\src` - директория c исходным кодом фреймворка
* Jenkins установлен в качестве системной службы Windows
* Запуск службы настроен под учетной записью текущего пользователя (пользователь, под которым производится настройка)

Настройка Jenkins
----

#### Зависимости

* Git
* Python > 3.6
* Venv, pip
* Jenkins (Если Jenkins установлен как служба Windows необходимо настроить запуск службы под текущей учетной записью (не системной))

#### Создание и настройка директории с виртуальным окружением

Для запуска тестов будем использовать отдельные директории для `Venv` и для исходного кода.
Данное окружение будет едино для всех сборок. Обновление исходного кода проекта и установка зависимостей будет производится специальной задачей в Jenkins.
Данную задачу можно запускать как вручную, так и по расписанию или по определенным событиям (коммит и т.д.).

* Открываем терминал Windows (cmd.exe), выполняем команды:

    > * `D:`
    > * `mkdir D:\smd_framework`
    > * `mkdir D:\smd_framework\src`
    > * `cd D:\smd_framework`
    > * `C:\Program Files\Python\Python36\python.exe -m virtualenv venv` (путь до python.exe может отличаться, в каталоге `D:\smd_framework\` должна появится директория `venv`)
    > * `venv\Scripts\activate.bat` (в консоли должен появиться знак активированного виртуального окружения: `(venv)`)
    > * `python -m pip install --upgrade pip` (обновляем pip)

#### Установка и настройка плагинов и переменных

* Установить Allure плагин для Jenkins (**Jenkins / Настроить Jenkins / Управление плагинами**)
* Настроить Allure (**Jenkins / Настроить Jenkins /Конфигурация глобальных инструментов / Allure Commandline**):

    > * `Имя`: allure
    > * `Install automatically`: Установить галочку
    > * Добавить установщик `From Maven Central` (если он еще не выбран, а также удалить прочие установщики)
    > * Выбрать самую свежую версию для установщика `From Maven Central`
    > * Нажать `Сохранить`

* Проверить путь до исполняемого файла Git (**Jenkins / Конфигурация глобальных инструментов / Path to Git executable**: `C:\Program Files\Git\cmd\git.exe`)
* Установленные браузеры (для запуска тестов или настроенный selenoid на удаленной/локальной машине)
* Настраиваем глобальные переменные окружения (**Jenkins / Настройка / Конфигурация системы**):

    > * `Environment variables`: Ставим галочку
    > * Нажать `Добавить`
    > * `SRC_PATH`: `D:\smd_framework\src`
    > * `TESTS`: `$SRC_PATH\tests`
    > * `VENV`: `D:\smd_framework\venv`
    > * `VENV_ACT`: `$VENV\Scripts\activate.bat`
    > * Нажать `Сохранить`

#### Создание задачи для обновления исходного кода фреймворка и установки зависимостей:

* На стартовой странице Jenkins нажимаем `Создать Item`
* Выбираем вариант `Создать задачу со свободной конфигурацией`, указываем имя задачи `FrameworkBuilder`
* Управление исходным кодом: `Git`
    > * `Repository URL`: `https://gitlab.com/hda-at/smd_mos.git`
    > * `Credentials`: указываем учетные данные

* Использовать другую директорию: `$SRC_PATH`
* Сборка:
    > * Добавить шаг сборки: `Выполнить команду Windows`
    > * Команда:
    > 
    > 
    >     CALL %VENV_ACT%
    >     pip install -r requirements.txt
* Нажать `Сохранить`

#### Создание задачи для запуска тестов:

* На стартовой странице Jenkins нажимаем `Создать Item`
* Выбираем вариант `Создать задачу со свободной конфигурацией`, указываем имя задачи `PositiveTest`
* Сборка:
    > * Добавить шаг сборки: `Выполнить команду Windows`
    > * Команда:
    > 
    > 
    >     CALL %VENV_ACT%
    >     SET ALR_DIR=%WORKSPACE%\allure-results
    >     CD %TESTS%
    >     pytest -m positive --alluredir="%ALR_DIR%"
* Послесборочные операции:
    > * Добавить шаг после сборки: `Allure Report`
* Нажать `Сохранить`

#### Дополнительные параметры запуска тестов:
* Для запуска конкретного файла, заменить последнюю команду:
    > `pytest ui\test_login.py --alluredir="%ALR_DIR%"`

* Для запуска тестов в несколько потоков используется параметр `-n X`:
    > `pytest -n 3 -m positive --alluredir="%ALR_DIR%"`
    
    > В случае ui тестов будет одновременно запущенно 3 браузера

* Для перезапуска тестов, которые завершились с ошибкой, используется параметр `--rerun=X`:
    > `pytest -m positive --alluredir="%ALR_DIR%" --rerun=2`
    
    > При завершении теста с ошибкой, pytest запустит данный тест дополнительно, до первого удачного запуска, или то кол-во раз, которое передали в качестве значения

Более подробно параметры командной строки `pytest` рассмотрены в файле `README.MD`
