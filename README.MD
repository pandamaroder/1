Общая информация о проекте
----

#### Используемые библиотеки:
* [Pytest](https://pytest.org) - Фреймворк для тестирования
* [Allure](http://allure.qatools.ru/) - Построение отчетов об автоматизированном тестировании
* [Selenium](https://www.seleniumhq.org/) - Инструмент для автоматизации действий веб-браузера
* [Selene](https://github.com/yashaka/selene) - Фреймворк для автоматизированного тестирования веб-приложений на основе Selenium WebDriver

#### Варианты применения:

* Локальный запуск функциональных `и не только` тестов на компьютере разработчика или тестировщика
    > `Необходимо наличие установленных браузеров и регулярное обновление 'драйверов браузера' на локальном компьютере`

* Локальный запуск тестов с использованием [Selenoid](https://github.com/aerokube/selenoid) установленным и настроенным на удаленном сервере
    > `Быстрое развертывание и обновления браузеров и драйверов, запуск браузера происходит в docker контейнере, который содержит актуальную версию браузера`
    
    > `Возможно тестирование на разных версиях браузера`

* Использование систем CI/CD: [Jenkins](https://jenkins.io/) и подобных
    > `Необходимо наличие установленного и настроенного` [Selenoid](https://github.com/aerokube/selenoid)

#### Структура проекта:

    .
    ├── framework                           # Фреймворк, вспомогательные классы, файлы, тестовые данные и PageObjects
    │   ├── drivers                         # Каталог с драйверами для разных платформ (локальный запуск браузера)
    │   │   ├── LINUX                       # Драйвера для браузеров под платформу Liniux
    │   │   │   ├── chromedriver            # Драйвер для браузера Chrome
    │   │   │   └── geckodriver             # Драйвер для браузера Firefox
    │   │   ├── MAC                         # Драйвера для браузеров под платформу macOS
    │   │   │   ├── chromedriver            # Драйвер для браузера Chrome
    │   │   │   └── geckodriver             # Драйвер для браузера Firefox
    │   │   ├── WINDOWS                     # Драйвера для браузеров под платформу Windows
    │   │   │   ├── chromedriver.exe        # Драйвер для браузера Chrome
    │   │   │   ├── geckodriver.exe         # Драйвер для браузера Firefox
    │   │   │   ├── geckodriver_32.exe      # Драйвер для браузера Firefox x32
    │   │   │   └── IEDriverServer.exe      # Драйвер для браузера IE
    │   │   └── webdriver_manager.py        # Вспомогательные методы для инициализации Selenium WebDriver
    │   ├── resources                       # Каталог с ресурсами и тестовыми данными
    │   │   ├── img                         # Картинки, необходимые для прохождения тестов
    │   │   │   ├── empty.txt               # "Рисунок" для проверки вывода ошибки
    │   │   │   └── scan.jpg                # Рисунок для заполнения формы регистрации
    │   │   └── test_params                 # Каталог со вспомогательными классами и переменными, содержащие тестовые данные
    │   │       ├── login_page.py           # Тестовые данные для формы авторизации на странице /login
    │   │       └── registration_page.py    # Тестовые данные для формы регистрации на странице /registration
    │   ├── ui_pages                        # PageObjects для функциональных тестов
    │   │   ├── login_page.py               # PageObjects для страницы /login
    │   │   └── registration_page.py        # PageObjects для страницы /registration
    │   └── config.py                       # Вспомогательные методы для настройки фреймворка, настройки в файле defaults.ini и параметры командной строки
    ├── reports                             # Отчеты о прохождении тестов
    │   ├── allure                          # Отчеты Allure (если активировано через настройки)
    │   └── selene                          # Скриншоты в случае падения функционального теста (если Allure отключен)
    ├── tests                               # Директория с тестовыми пакетами, модулями, классами и методами
    │   ├── ui                              # Функциональные тесты (а также тесты которые требуют запуска браузера)
    │   │   ├── conftest.py                 # Вспомогательный файл Pytest для каталога ui и дочерних, хранит "фикстуры" для тестовых методов данного каталога
    │   │   ├── test_login.py               # Функциональные тесты для страницы /login
    │   │   └── test_registration.py        # Функциональные тесты для страницы /registration
    │   └── conftest.py                     # Вспомогательный файл Pytest для каталога tests и дочерних
    ├── defaults.ini                        # Настройки "по умолчанию" для фреймворка
    ├── pytest.ini                          # Настройки Pytest
    └── requirements.txt                    # Список зависимостей проекта для установки с помощью pip

#### Требования к именованию и расположению тестовых модулей, функций, классов и методов

* Тестовые модули должны находится в каталоге **./tests**
* Название каждого модуля должно начинаться с **test\_**
* Название каждого класса должно начинаться с **Test**
* Название каждой функции или метода должно начинаться с **test\_**

`Данное поведение, можно переопределить в конфигурации Pytest (./pytest.ini)`
* При создании вложенных каталогов необходимо наличие файла **\_\_init\_\_.py** в таком варианте не будет конфликтов при одинаковом наименовании модуля в разных каталогах
* Имена функций/классов внутри одного модуля и методов внутри одного класса должны отличаться

#### Описание файла ./defaults.ini
Параметры для раздела **\[selenium\]**:
* browser = chrome
    > Используемый браузер (по умолчанию Chrome). Возможные значения: chrome, firefox, explorer
    
    > Можно переопределить через параметр консоли: --browser=chrome

* windows_size = 640x480
    > Используемый размер окна у браузера (по умолчанию на весь экран). Возможные значения: 640x480, 1980x1200 и т.д.
    
    > Можно переопределить через параметр консоли: --windows_size=1366x768

* driver_url = http://localhost:4723/wd/hub
    > URL Selenoid сервера
    
    > Можно переопределить через параметр консоли: --driver_url='http://192.168.1.1:4723/wd/hub'

* browser_version = 74.0.3729.131
    > Версия браузера при использовании Selenoid, контейнер с указанной версией должен быть установлен на сервере, по умолчанию запускается самая свежая установленная версия
    
    > Можно переопределить через параметр консоли: --browser_version=69

Параметры для раздела **\[selene]**:
* base_url = https://smd.mos.ru/
    > Корневой URL для тестируемого сайта, при условии, что все тесты настроены на использование относительных URL.
    В случае если base_url=https://smd.mos.ru/, а в PageObjects или тесте используется метод open_url('login/'),
    итоговый URL будет иметь вид: https://smd.mos.ru/login/
    
    > Можно переопределить через параметр консоли: --base_url='https://smd-demo.mos.ru/'

* timeout = 10
    > Максимально время ожидания наличия элемента страницы или выполнения условия, в секундах. По умолчанию: 4 секунды.
    
* poll_during_waits = 0.5
    > Время между повторными запросами на наличие элемента страницы или выполнения условия, в секундах. По умолчанию: 0.1 секунды.

* reports_folder = reports/selene/
    > Каталог для скриншотов при падении тестов (автоматически создаются библиотекой Selene) если не используется Allure

Параметры для раздела **\[allure]**:
* alluredir = reports/allure/
    > Каталог для отчетов Allure. По умолчанию: не указано (отчеты не создаются)
    Если указан относительный путь, данный каталог будет создан внутри проекта.
    
    > Можно переопределить через параметр консоли: --alluredir='/tmp/allure-reports' (необходимо указывать полный путь)

* clean-alluredir = True
    > Очистить каталог Allure перед создание нового отчета. По умолчанию: False
    
    > Можно переопределить через параметр консоли: --clean-alluredir=True

#### Описание файла ./tests/conftest.py
Файлы **conftest.py** используются для создания фикстур Pytest и запуска различных "хуков", применяются для всех модулей внутри каталога и всех подкалогов

В данном файле использованы следующие "хуки":
* **pytest_addoption** - Выполняется при инициализации Pytest и добавляет в конфигурацию Pytest следующие опции командной строки:

    - --base_url
    - --browser
    - --windows_size
    - --driver_url
    - --browser_version
* **pytest_configure** - Выполняется во время конфигурирования Pytest и его плагинов:

    - Выполняет настройку фреймворка на основе параметров командной строки и файла **./defaults.ini**
    - Настройку фреймворка производит класс **FrameworkConfig** из модуля **./framework/config.py**
    - Параметры командной строки имеют больший приоритет

#### Описание файла ./tests/ui/conftest.py
Указанный файл действует только на каталог **./tests/ui/** и его подкаталоги в котором расположены функциональные тесты или тесты требующие браузер
tests -> ui -> conftest.py; test_login.py, test 

В данном файле использован следующий "хук":
* **pytest_exception_interact** - Выполняется при возникновении необработанного исключения во время выполнения какого-либо тестового метода
    - Вызывает функцию **screenshot_for_allure_on_fail** из модуля **./framework/drivers/webdriver_manager.py**
    - Данная функция создает скриншот страницы под именем "screenshot_on_fail" и прикладывает его к отчету Allure

Реализованы следующие фикстуры:
* **setup_driver** - Инициализация Selenium WebDriver и запуск браузера
    - Параметр фикстуры **scope='session'** означает что она будет применена к тестовой сессии (единожды, и будет действовать от запуска первого тестового метода и до завершения самого последнего)
    - Параметр фикстуры **autouse=True** означает что она будет запускаться автоматически

* **setup_driver_if_not_open** - Инициализация Selenium WebDriver и запуск браузера (в случае его отсутствия, аварийного закрытия или сбоя)
    - По умолчанию данная фикстура применяется ко всем тестовым методам
    - Параметр фикстуры **autouse=True** означает что она будет запускаться автоматически

* **re_init_driver** - Закрывает открытый браузер и запускает новый (в случае когда требуется продолжить тестирование с 'чистого листа', сбросить кеш браузера и т.д.)
    - Для ее использования необходимо прописать декоратор **@pytest.mark.usefixtures('re_init_driver')** для тестового метода или всего тестового класса
    - Если фикстура применена к классу, то драйвер будет перезапускаться перед каждым тестовым методом данного класса

* **allure_screen** - Делает снимок экрана в браузере по завершению тестового метода
    - Для ее использования необходимо прописать декоратор **@pytest.mark.usefixtures('allure_screen')** для тестового метода или всего тестового класса, так же можно использовать для методов PageObjects
    - Если фикстура применена к классу, то скриншоты будут создаваться после каждого тестового метода данного класса

#### Примеры запуска тестовых сценариев из командной строки
* `pytest tests/ui/test_login.py` - Запуск всех тестовых методов из модуля **test_login.py** (необходимо указывать путь до модуля отнисительно корня проекта)
* `pytest tests/ui/test_login.py::TestRegistrationForm` - Запуск всех тестовых методов класса **TestRegistrationForm** из модуля **test_login.py**
* `pytest tests/ui/test_login.py::TestRegistrationForm::test_login` - Запуск только одного тестового метода **test_login**
* `pytest -m positive` - Запуск всех тестовых методов из проекта, у которых присутствует декоратор **@pytest.mark.positive**
* `pytest -m positive tests/ui` - Запуск всех тестовых методов из каталога **./tests/ui**, у которых присутствует декоратор **@pytest.mark.positive**
    
    * Декорировать можно как класс так и отдельный тестовый метод
    * Можно назначать несколько меток
    * Требования к именованию меток такие же, как к именам функций и переменных
    * Перед прогоном тестов можно удостовериться что выбраны все необходимые тестовые методы с помощью опции `--collect-only`: `pytest --collect-only -m positive`

* `pytest -m positive --browser=firefox --windows_size='640x480'` - Запуск всех тестовых методов с меткой **positive** в браузере Firefox с размером окна 640x480
* `pytest -m positive --base_url='https://smd-demo.mos.ru/' --alluredir=/tmp/allure` - Запуск всех тестовых методов с меткой **positive** для домена **smd-demo** и генерацией отчета Allure в директории **/tmp/allure**

Зависимости проекта
----

* Python 3.6 `и выше`
* Venv
* Pip
* Git
* Установленные браузеры `Chrome, Firefox, IE 11` последних версий
> `Возможно использование` [Selenoid](https://github.com/aerokube/selenoid)

Установка
----
* Клонировать проект `git clone` в выбранную директорию
* Установить и активировать Venv:

   > - pip3 install -U virtualenv
   > - python3 -m virtualenv venv
   > - venv\Scripts\activate.bat
   
   В консоли должен появиться знак активированного виртуального окружения: `(venv)`
   
* Установить зависимости проекта `pip install -r requirements.txt`

Для проверки правильности развертывания проекта необходимо выполнить консольную команду `pytest --collect-only` в корневом каталоге проекта.
Данная команда выведет общую информацию об окружении и соберет информацию об имеющихся тестовых методах в проекте, без запуска самих тестовых методов.

scoop
iex (new-object net.webclient).downloadstring('https://get.scoop.sh')
Set-ExecutionPolicy RemoteSigned -scope CurrentUser
set-executionpolicy -s cu unrestricted


scoop install allure
allure serve C:\Users\o.kukushkina\PycharmProjects\smd_mos\results

Ссылки
----

#### Pytest
* [Введение в PyTest](https://medium.com/@dmrlx/%D0%B2%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B2-pytest-cc6175c7d0dc)
* [Как в Яндексе используют PyTest и другие фреймворки для функционального тестирования](https://habr.com/ru/company/yandex/blog/242795/)
* [Python Testing с pytest. Начало работы с pytest, Глава 1](https://sohabr.net/habr/post/448782/)
* [Python Testing с pytest. Глава 2, Написание тестовых функций](https://sohabr.net/habr/post/448788/)
* [Python Testing с pytest. ГЛАВА 3 pytest Fixtures](https://sohabr.net/habr/post/448786/)
* [Python Testing с pytest. Builtin Fixtures, Глава 4](https://sohabr.net/habr/post/448792/)
* [Python Testing с pytest. Плагины, ГЛАВА 5](https://sohabr.net/habr/post/448794/)
* [Python Testing с pytest. Конфигурация, ГЛАВА 6](https://sohabr.net/habr/post/448796/)
* [Python Testing с pytest. Использование pytest с другими инструментами, ГЛАВА 7](https://sohabr.net/habr/post/448798/)

#### Allure
* [Allure 2: тест-репорты нового поколения](https://habr.com/ru/company/jugru/blog/337386/)
* [Allure-framework. Часть 1](https://habr.com/ru/company/sberbank/blog/358836/)
* [Allure-Framework. Работа с кодом](https://habr.com/ru/company/sberbank/blog/359302/)

#### Selenium
* [Selenium для Python. Глава 1. Установка](https://habr.com/ru/post/248559/)
* [Selenium для Python. Глава 2. Первые Шаги](https://habr.com/ru/post/250921/)
* [Selenium для Python. Глава 3. Навигация](https://habr.com/ru/post/250947/)
* [Selenium для Python. Глава 5. Ожидания](https://habr.com/ru/post/273089/)
* [Selenium для Python. Глава 6. Объекты Страницы](https://habr.com/ru/post/273115/)
